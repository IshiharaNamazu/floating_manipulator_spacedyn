%%%%%%
%%%%%% SpaceDyn �T���v���v���O����
%%%%%%
%%%%%% 2�����N�V���A���A�[�������F�����{�b�g�̃V�~�����[�V����
%%%%%%
%%%%%% 2018�N5��16��
%%%%%%

% �u%�v�̓R�����g�A�E�g�ł��D
%�@�u'�v�͓]�u�ł��D
%�@�u;�v�͌v�Z�̕\����\����C�s��̉��s��\���܂��D
%�@�Z�@���@�֐��i���j�́C���������C�Z���v�Z���ʂł��D

addpath('../spacedyn_v2r1')
clc
clear
close all

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%% global �ϐ��̒�` %%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% �S�Ă̊֐��y�сC���C�����[�`�����ŋ��ʂŎg�p�����ϐ�
global d_time
global Gravity
global Ez

%%%%%% �֐߂̒P�ʉ�]���x�N�g�� %%%%%
Ez =[0 0 1]';

d_time =0.01; % �V�~�����[�V�����̂P�X�e�b�v������̎���

Gravity =[0 0 0]'; % �d�́i�n���d�͂Ȃ�� Gravity = [0 0 -9.8]�j


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%% �����N�p�����[�^��`�ƕϐ��̏����� %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
LP = Sample_LP();%LP�P�Ƃ��ɂ��Ă��悢i.         Sample_LP()���Ăяo����LP�Ɋi�[
SV = Sample_SV( LP );%SV�����O�͎����Œ�`�ł���       Sample_SV(LP)���Ăяo����SV�Ɋi�[   �����ɃT�C�Y�����߂Ă���

%%%%% �x�[�X���� num_e �Ŏw�肳�ꂽ���܂ł����Ԋ֐�(�����N)�����߂� %%%%%
num_e = 1;%�A�[���̐�������H
joints = j_num(LP, num_e);%�A�[���̎��܂Ń����N�̐������߂�

%%%%% ���{�b�g�̏����֐ߊp�x��ݒ� %%%%%
SV.q = [pi/6 -pi/3]';


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% �֐ߐ���Ŏg���p�����[�^�̒�` %%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%PD���������
des_q = [-pi/6 pi/3]'; % �ڕW�֐ߊp[rad]
des_qd = [0 0]'; % �ڕW�֐ߊp���x[rad/s]
kp = 10; % ���t�B�[�h�o�b�N�Q�C��P
kd = 5; % �����t�B�[�h�o�b�N�Q�C��D


%%%%% �V�~�����[�V�������ʂ��������ނ��߂̃t�@�C���̒�` %%%%%
%fopen �t�@�C�����J���܂��͊J���Ă���t�@�C���Ɋւ�����̎擾
fidw = fopen( 'sample.dat','w' );
%w�F�������ݗp�Ƀt�@�C�����J�����V�K�t�@�C�����쐬
%dat�t�@�C�����J���Ă���Ɍ��ʂ���������ł����錾


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%% ��������V�~�����[�V�������[�v�X�^�[�g %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


for time = 0:d_time:10

        time % ���݂ǂ̃X�e�b�v���v�Z���Ă��邩����ʂɏo�́i�G���ĂȂ��̂� �j

        %%%%%%%%%%%%%%%% �O�͂̌v�Z %%%%%%%%%%%%%%%%%%%%%%%%%%%%

        % ����͍l�����Ȃ�

        %%%%%%%%%%%%%%%% �ڕW�g���N����̌v�Z %%%%%%%%%%%%%%%%%%%


        %����g���N
        %�֐ߊp�x��pd����@
        %�����Q�C��*(�ڕW�֐ߊp���x-���݂̊֐ߊp���x)+���Q�C���i�ڕW�֐ߊp�x-���݂̊֐ߊp�x)
        SV.tau = kp*(des_q - SV.q) + kd*(des_qd - SV.qd);

        %%%%%%%%%%%%%%%%%%%% �����͊w�̌v�Z %%%%%%%%%%%%%%%%%%%%%
        % �^����������莟�̎��Ԃ̃x�[�X�̉����x�y�ъ֐ߊp�����x���v�Z���C
        % �����ϕ����邱�Ƃɂ��C�x�[�X�̈ʒu�i6�~1�j�C���x(6�~1)�y�сC
        % �֐ߊp�C�֐ߊp���x�����߂�D
        % �^�����������̑��x����`�����v�Z���邽�߂ɁC
        % �ċA�j���[�g���I�C���[�@�ɂ��t���͊w�������ŉ����Ă���D
        SV = f_dyn_rk2( LP, SV );



        %%%%%%%%%%%%%%%%%%%%%%% ���^���w %%%%%%%%%%%%%%%%%%%%%%%%%

        %%%%% ���ʒu�p���̌v�Z (���^���w) %%%%%%
        % �e�����N�̍��W�ϊ��s��(�����]���s��)�̌v�Z
        % �i�����Ni �� �������W�n�j
        SV =calc_aa( LP, SV );

        % �e�����N�d�S�̈ʒu�x�N�g��(6�~1)���v�Z
        SV =calc_pos( LP, SV );

        %%%%% ���ʒu�p���̌v�Z %%%%%
        [ POS_e, ORI_e ] =f_kin_e(LP, SV, joints);
        %POS_e ���̈ʒu
        %ORI_e ���̕����]���s��i�x�[�X���猩���j
        %joints ���̃����N�ԍ�

        %%%%% ���p���̃I�C���[�p�\�� %%%%%
        Qe_rad =dc2rpy(ORI_e');%ORI_e�̓]�u��Y��Ȃ��I(SpceDyn�̓����セ���Ȃ��Ă���)

        %%%%% �x�[�X�p���̃I�C���[�p�\�� %%%%%%
        SV.Q0 =dc2rpy(SV.A0');  %�����]���s�񂩂�I�C���[�p�ɕϊ�

        %%%%% �p�x��rad����deg�֕ϊ� %%%%%
        % ���̎p��
        Qe_deg =Qe_rad*180/pi;
        % �x�[�X�̎p��
        Q0_deg =SV.Q0*180/pi;
        % �֐ߊp�x
        q_deg =SV.q*180/pi;

        %%%%%%%%%%%%%%%%%%%%% ���ʂ��t�@�C���ɏo�� %%%%%%%%%%%%%%%%%%%%%
        %%% ���ԁC�x�[�X�̈ʒu�E�p���C���̈ʒu�E�p���C�֐ߊp�x
        %fprintf �f�[�^�̃t�@�C���ւ̏�������
        fprintf(fidw,'%g %g %g %g %g %g %g %g %g %g %g %g %g %g %g\n',time,SV.R0,Q0_deg,POS_e,Qe_deg,q_deg);
        %1(time)+3(SV.R0+)+3(Q0_deg)+3(POS_e)+3(Qe_deg)+2(q_deg)=15
        % %g�͉E�̕ϐ��Əꏊ����v������
end

%%%%%%%%%%%%%%%%%%%%%%%%%%% �V�~�����[�V�������[�v�����܂� %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ���ʂ̕\�� %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% ���ʃt�@�C�����J�� %%%%%
%r�F�ǂݎ��p�Ƀt�@�C�����J��
fid = fopen('sample.dat','r');

%%%%% �f�[�^���s��Ɋi�[���� %%%%%
%fscanf �e�L�X�g�t�@�C������̃f�[�^�̓ǂݎ��
%[15 inf]��tmp�̎������w��
%fscanf�̓f�[�^�������ɓ���
tmp = fscanf(fid,'%g %g %g %g %g %g %g %g %g %g %g %g %g %g %g',[15 inf]);
%%%%% �f�[�^�s���]�u���� %%%%%
tmp = tmp';

%%%%% �t�@�C������� %%%%%
fclose(fid);

%%%%% �O���t�̕`�� %%%%%
%%% �x�[�X�̈ʒu
figure(1)
plot(tmp(:,1),tmp(:,2:4),'-');
title('SV.R0');
xlabel('Time [s]'); ylabel('position of Base [m]');
grid on;

%%% �x�[�X�̎p��
figure(2)
plot(tmp(:,1),tmp(:,5:7),'-');
title('Q0\_deg');
xlabel('Time [s]'); ylabel('Rotation of Base [deg]');
grid on;

%%% ���̈ʒu
figure(3)
plot(tmp(:,1),tmp(:,8:10),'-');
title('POS_e');
xlabel('Time [s]'); ylabel('posiion of Hand [m]');
grid on;

%%% ���̎p��
figure(4)
plot(tmp(:,1),tmp(:,11:13),'-');
title('Qe\_deg');
xlabel('Time [s]'); ylabel('Rotation of Hand [deg]');
grid on;

%%% �֐ߊp�x
figure(5)
plot(tmp(:,1),tmp(:,14:15),'-');
title('q\_deg');
xlabel('Time [s]'); ylabel('Joint angle [deg]');
grid on;


%%% EOF
